name: Docker Compose CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  compose-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Docker
        uses: docker/setup-buildx-action@v2

      - name: Setup Docker Compose
        uses: docker/setup-compose-action@v3

      - name: Validate compose file
        run: docker-compose config

      - name: Build images
        run: docker-compose build --parallel

      - name: Start services
        run: |
          docker-compose up -d
          sleep 20  # Reduced wait time
          
          echo "=== Service Status ==="
          docker-compose ps

      - name: Health checks
        run: |
          echo "=== Health Checks ==="
          
          # Backend health check
          if curl -s -f http://localhost:8000/docs > /dev/null; then
            echo "✅ Backend is healthy"
          else
            echo "❌ Backend health check failed"
            docker-compose logs backend --tail=30
            exit 1
          fi
          
          # Frontend health check
          if curl -s -f http://localhost:80/health > /dev/null; then
            echo "✅ Frontend is healthy"
          else
            echo "⚠ Frontend health endpoint not available, checking main page..."
            if curl -s -f http://localhost:80 > /dev/null; then
              echo "✅ Frontend is responding"
            else
              echo "❌ Frontend health check failed"
              docker-compose logs frontend --tail=30
              exit 1
            fi
          fi

      - name: Run quick smoke test
        run: |
          echo "=== Smoke Test ==="
          # Test backend API
          curl -s http://localhost:8000/docs | grep -q "FastAPI" && echo "✅ Backend API docs available"
          
          # Test frontend static files
          curl -s http://localhost:80 | grep -q "<html" && echo "✅ Frontend HTML served"

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleanup ==="
          docker-compose down -v
          docker system prune -f
