name: CD - Ready for Deployment

on:
  workflow_run:
    workflows: ["Smoke Test", "Run Tests with k6", "Integration Test"]
    types: [completed]
  workflow_dispatch:

jobs:
  mark-ready:
    runs-on: ubuntu-latest
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Mark as ready for deployment
        run: |
          echo "ðŸŽ‰ ALL TESTS PASSED!"
          echo ""
          echo "=== Deployment Checklist ==="
          echo "âœ… Code committed to main"
          echo "âœ… Backend tests passed"
          echo "âœ… Frontend tests passed"
          echo "âœ… Integration tests passed"
          echo "âœ… Load tests passed"
          echo "âœ… Smoke tests passed"
          echo ""
          echo "=== Next Steps ==="
          echo "1. Set up deployment server (VPS with Docker)"
          echo "2. Add SSH secrets to GitHub:"
          echo "   - SSH_HOST"
          echo "   - SSH_USER"
          echo "   - SSH_PRIVATE_KEY"
          echo "3. Create docker-compose.prod.yml on server"
          echo "4. Run deployment manually or set up auto-deploy"
          echo ""
          echo "ðŸ“… $(date)"
          
      - name: Create deployment tag
        if: github.event.workflow_run.conclusion == 'success'
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð»Ñ‘Ð³ÐºÐ¸Ð¹ Ñ‚ÐµÐ³ Ð´Ð»Ñ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº
          echo "Creating deployment marker..."
          DEPLOYMENT_ID=$(date +%Y%m%d-%H%M%S)
          echo "deployment-ready-$DEPLOYMENT_ID" > .deployment-ready
          echo "âœ… Marked as ready for deployment: $DEPLOYMENT_ID"
          
      - name: Upload deployment marker
        uses: actions/upload-artifact@v4
        with:
          name: deployment-ready
          path: .deployment-ready
          retention-days: 7
