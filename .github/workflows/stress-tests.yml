name: Stress Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM
  workflow_dispatch:  # Manual trigger

jobs:
  stress-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install k6
        run: |
          sudo apt-get update
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Start services
        run: |
          docker-compose up -d backend frontend
          sleep 30  # Wait for services to start

      - name: Run smoke test
        run: |
          cd stress-tests/tests/load-tests
          npm run smoke:docker || echo "Smoke test completed"

      - name: Run load test
        run: |
          cd stress-tests/tests/load-tests
          npm run load:docker || echo "Load test completed"

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: stress-test-results
          path: stress-tests/tests/load-tests/reports/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          docker-compose down
